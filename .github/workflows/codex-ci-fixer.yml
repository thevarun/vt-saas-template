name: Codex CI fixer

on:
  workflow_run:
    workflows: [CI]
    types: [completed]

jobs:
  spawn_fixer:
    if: github.event.workflow_run.conclusion == 'failure'
    runs-on: ubuntu-latest
    permissions:
      actions: read
      pull-requests: write
      issues: write
    steps:
      - name: Comment to trigger Codex task
        uses: actions/github-script@v7
        with:
          script: |
            const pullRequests = context.payload.workflow_run.pull_requests;
            if (!pullRequests || pullRequests.length === 0) {
              core.info('No pull requests found for this workflow run.');
              return;
            }

            const prNumber = pullRequests[0].number;
            const { data } = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id,
            });

            const failedJobs = data.jobs
              .filter((job) => job.conclusion === 'failure')
              .map((job) => `- ${job.name} (${job.html_url})`)
              .join('\n');

            const summary = failedJobs.length > 0
              ? `CI failed in the following jobs:\n${failedJobs}`
              : `CI failed in workflow run ${context.payload.workflow_run.html_url}.`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `@codex please fix the CI failures for this PR.\n\n${summary}\n\nKeep changes minimal; update tests if needed; summarize changes.`,
            });
